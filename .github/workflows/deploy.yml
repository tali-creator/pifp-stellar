name: Deploy to Futurenet

on:
  push:
    branches: [ "main" ]

env:
  # Targeting the specific contract directory mentioned in the docs
  MANIFEST_PATH: contracts/pifp_protocol/Cargo.toml

jobs:
  deploy:
    name: Build and Deploy Contract
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Modern, actively maintained Rust toolchain
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      # Cache to optimize build times per requirements
      - name: Cache Cargo Registry & Build Artifacts
        uses: Swatinem/rust-cache@v2

      - name: Install Stellar CLI
        # Downloading the pre-compiled binary saves ~5 minutes compared to 'cargo install'
        run: |
          wget https://github.com/stellar/stellar-cli/releases/download/v25.1.0/stellar-cli-25.1.0-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf stellar-cli-25.1.0-x86_64-unknown-linux-gnu.tar.gz
          sudo mv stellar-cli-25.1.0-x86_64-unknown-linux-gnu/stellar /usr/local/bin/

      - name: Build Smart Contract
        # Compiles the contract to the wasm32 target
        run: stellar contract build --manifest-path ${{ env.MANIFEST_PATH }}

      - name: Deploy to Futurenet
        # Securely maps the GitHub Secret to an environment variable for this specific step
        env:
          SOROBAN_SECRET_KEY: ${{ secrets.SOROBAN_SECRET_KEY }}
        run: |
          # 1. Deploy the contract and capture the output ID
          # The pipeline will automatically fail here if the deployment crashes 
          # (e.g., insufficient funds or bad secret) due to standard bash 'set -e' behavior.
          CONTRACT_ID=$(stellar contract deploy \
            --wasm target/wasm32-unknown-unknown/release/pifp_protocol.wasm \
            --source "$SOROBAN_SECRET_KEY" \
            --network futurenet)
          
          echo "Successfully deployed to Futurenet! Contract ID: $CONTRACT_ID"
          
          # 2. Write the ID to deployments.json
          echo "{\"contract_id\": \"$CONTRACT_ID\", \"network\": \"futurenet\", \"timestamp\": \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\"}" > deployments.json

      - name: Upload Deployment Artifact
        # Safely exposes the deployments.json file for frontend devs to download
        # without polluting the Git commit history and causing an infinite CI loop.
        uses: actions/upload-artifact@v4
        with:
          name: deployments-json
          path: deployments.json